---
import Layout from "../../layouts/Layout.astro";
import SchemaExplorer from "../../components/SchemaExplorer.svelte";
import StructureOverview from "../../components/StructureOverview.svelte";
import MessageSidebar from "../../components/MessageSidebar.svelte";
import { getVersions, getMessages } from "../../utils/schemas";
import { getSchemaDescription } from "../../utils/schema-description";
import ExamplesButton from "../../components/ExamplesButton.svelte";
import ValidateModal from "../../components/ValidateModal.svelte";
import { API_URL } from "../../utils/config";
import { MODAL_IDS } from "../../utils/constants";
import type { SchemaFileRef, WorkedExamplesMap } from "../../utils/types";
import workedExamples from "../../data/worked_examples.json";
import fs from "node:fs";
import path from "node:path";

export function getStaticPaths() {
    const versions = getVersions();
    const paths: { params: { version: string; message: string }; props: { versions: string[]; messages: string[]; allVersions: string[] } }[] = [];

    versions.forEach((version) => {
        const messages = getMessages(version);
        messages.forEach((message) => {
            paths.push({
                params: { version, message },
                props: { versions, messages, allVersions: versions },
            });
        });
    });
    return paths;
}

const { version, message } = Astro.params;
const { messages, allVersions } = Astro.props;

const schemaDir = path.join(
    process.cwd(),
    "public",
    "schemas",
    version,
    message,
);
let schemaFiles: SchemaFileRef[] = [];

// Fallback if directory doesn't exist (e.g. detailed flattened schemas not generated yet)
// But we expect them to be there.
try {
    if (fs.existsSync(schemaDir)) {
        schemaFiles = fs
            .readdirSync(schemaDir)
            .filter((f) => f.endsWith(".xsd"))
            .map((f) => ({
                name: f,
                url: `/schemas/${version}/${message}/${f}`,
            }));
    }
} catch (e) {
    console.error(`Error reading schema directory: ${schemaDir}`, e);
}

const mainSchemaFile =
    schemaFiles.find((f) => f.name === `${message}.xsd`)?.url ||
    schemaFiles.find((f) => f.name === `IATA_${message}.xsd`)?.url ||
    `/schemas/${version}/${message}.xsd`; // Fallback

const cleanMessageName = message.replace("IATA_", "");
const description = getSchemaDescription(version, message);

const examples =
    (workedExamples as WorkedExamplesMap)[message] ||
    (workedExamples as WorkedExamplesMap)[`IATA_${message}`] ||
    [];
---

<Layout
    title={`${cleanMessageName} - IATA NDC ${version} Schema | NDC Clearance`}
    description={description}
>
    <div slot="sidebar-content" class="h-full">
        <MessageSidebar
            client:load
            messages={messages}
            currentMessage={message}
            version={version}
            allVersions={allVersions}
        />
    </div>

    <div slot="sidebar-widgets">
        <StructureOverview client:load />
    </div>

    <div class="flex flex-col gap-4 h-full">
        <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-base-100 p-4 rounded-box shadow gap-4"
        >
            <div class="min-w-0 w-full sm:w-auto">
                <h1 class="text-xl sm:text-2xl font-bold break-words">
                    {message}
                </h1>
                <p class="text-sm opacity-70">Version {version}</p>
            </div>

            <div class="flex gap-2 items-center flex-none w-full sm:w-auto">
                {
                    examples.length > 0 && (
                        <ExamplesButton
                            client:load
                            examples={examples}
                            message={message}
                        />
                    )
                }
                <button
                    class="btn btn-primary btn-sm w-full sm:w-auto"
                    onclick={`document.getElementById('${MODAL_IDS.DOWNLOAD}').showModal()`}
                >
                    Download Schema
                </button>
                <ValidateModal
                    client:load
                    version={version}
                    message={message}
                    apiBaseUrl={API_URL}
                />
            </div>
        </div>

        <dialog id={MODAL_IDS.DOWNLOAD} class="modal">
            <div class="modal-box">
                <h3 class="font-bold text-lg mb-4">Download Schema Files</h3>
                <div class="flex flex-col gap-2 max-h-96 overflow-y-auto">
                    {
                        schemaFiles.map((file) => (
                            <a
                                href={file.url}
                                download={file.name}
                                class="flex items-center justify-between p-3 bg-base-200 rounded-lg hover:bg-base-300 transition-colors"
                            >
                                <span class="font-mono text-xs">
                                    {file.name}
                                </span>
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5 opacity-70"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                                    />
                                </svg>
                            </a>
                        ))
                    }
                </div>
                <div class="modal-action">
                    <form method="dialog">
                        {
                            /* if there is a button in form, it will close the modal */
                        }
                        <button class="btn">Close</button>
                    </form>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>

        <SchemaExplorer
            client:only="svelte"
            schemaUrl={mainSchemaFile}
            schemaFiles={schemaFiles}
        />
    </div>
</Layout>
