# AGENTS.md - NDC Clearance

## Project Overview

**NDC Clearance** is an interactive browser, validator, and diff tool for IATA NDC (New Distribution Capability) XML schemas. It serves airlines, travel agents, and developers working with the NDC standard by providing:

- Hierarchical browsing of XSD schema structures across NDC versions (21.3.5 through 25.4)
- Full-text search across schema elements, types, and documentation
- Side-by-side version diffing to identify schema changes
- XML validation against specific schema versions
- Worked examples from canonical shared content (`ndc_content/`) with IATA + custom sources
- Interactive Flow viewer with 100% coverage requirement for quality assurance
- An MCP (Model Context Protocol) server enabling AI agent integration

**Live deployment:** https://ndc-clearance.netlify.app
**MCP endpoint:** https://mcp-ndc.sunrisehikers.io/mcp/sse

---

## Repository Structure

```
ndc-viewer/
├── site/                    # Frontend - Astro + Svelte static site
├── backend/                 # Backend - Kotlin/Ktor validation & MCP server
├── tools/                   # Kotlin CLI tools for schema processing
├── ndc_schemas/             # Flattened schemas (generated by tools/)
├── raw_ndc_schemas/         # Original IATA schema archives
├── ndc_content/             # Canonical examples + flow metadata shared by site/backend
├── .github/workflows/       # CI/CD pipelines
├── docker-compose.yml       # Docker Compose for local dev (site + backend)
├── iata_ndc_messages.json   # Message definitions per version
├── screenshot.png           # Project screenshot
├── LICENSE                  # License file
└── README.md                # Project README
```

---

## site/ - Frontend

### Tech Stack

| Layer       | Technology                           |
|-------------|--------------------------------------|
| Framework   | Astro 5.x (static site generation)   |
| Components  | Svelte 5 (runes API: $state, $derived, $effect) |
| Styling     | Tailwind CSS 4.x + DaisyUI 5.x      |
| Testing     | Vitest + @testing-library/svelte     |
| Linting     | ESLint 9 + Prettier                  |
| Syntax HL   | highlight.js (XML language)          |
| TypeScript  | Strict mode                          |
| Node        | 24                                   |

### Key Commands

```bash
cd site
npm ci                   # Install dependencies
npm run dev              # Dev server at localhost:4321
npm run build            # Build to dist/ (runs copy-assets first)
npm run test             # Run Vitest tests
npm run lint             # ESLint check
npm run format           # Prettier formatting
npm run copy-schemas     # Copy ../ndc_schemas/ into public/schemas/
npm run copy-content     # Copy ../ndc_content/examples into public/content/examples
npm run copy-assets      # Runs copy-schemas + copy-content
```

### Pages

| Route                        | File                          | Purpose                          |
|------------------------------|-------------------------------|----------------------------------|
| `/`                          | `src/pages/index.astro`       | Home page, version browser, MCP setup guide |
| `/[version]/[message]`       | `src/pages/[version]/[message].astro` | Schema viewer (SSG)       |
| `/diff`                      | `src/pages/diff.astro`        | Schema version comparison tool   |
| `/404`                       | `src/pages/404.astro`         | Custom error page                |

### Components (`src/components/`)

**Core schema exploration:**
- `SchemaExplorer.svelte` - Main orchestrator; loads XSD via HTTP, manages search, tree state, tab switching
- `SchemaNode.svelte` - Recursive tree node renderer with lazy child loading, search highlighting, auto-scroll
- `SchemaDiffViewer.svelte` - Side-by-side version comparison with CSV export

**UI panels:**
- `SearchPanel.svelte` - Full-text search with keyboard shortcut (Ctrl+F), result dropdown, path breadcrumbs
- `TreeToolbar.svelte` - Floating toolbar with zoom (50-200%) and expand/collapse all
- `NodePropertiesPanel.svelte` - Right sidebar showing selected element metadata, docs, constraints
- `MessageSidebar.svelte` - Left sidebar with version selector and message list
- `VersionSelector.svelte` - Version dropdown with cross-version navigation and existence checking

**Content viewers:**
- `XmlSourceView.svelte` - Raw XML display with syntax highlighting, code folding, multi-file tabs, copy button
- `ExamplesButton.svelte` / `ExamplesModal.svelte` - Worked example browser
- `FlowHeader.svelte` - Flow title, description, and source attribution link
- `ValidateModal.svelte` - XML validation interface (calls backend API)
- `StructureOverview.svelte` - Schema statistics widget (elements, types counts)

### Utilities (`src/utils/`)

| File                    | Purpose                                                       |
|-------------------------|---------------------------------------------------------------|
| `schema-helpers.ts`     | XSD parsing: documentation extraction, type resolution, BFS element collection, search matching |
| `schemas.ts`            | Schema/version discovery from `public/schemas/` filesystem    |
| `config.ts`             | API_URL and MCP_URL configuration                             |
| `constants.ts`          | Search config, zoom range, tree depth, modal IDs              |
| `types.ts`              | TypeScript interfaces (SchemaStats, SearchResult, DiffItem, etc.) |
| `examples.ts`           | Canonical examples catalog loader + message filtering          |
| `stores.ts`             | Svelte writable store for schema statistics                   |
| `modal.ts`              | Dialog element opener helper                                  |
| `highlight.ts`          | highlight.js initialization with XML language                 |
| `schema-description.ts` | XSD root description extraction for meta tags                |
| `schema-paths.ts`       | SCHEMAS_DIR constant                                          |

### Performance Patterns

- Lazy child loading in tree nodes (on-demand resolution)
- Chunked BFS search (50-node chunks with async yields to prevent UI blocking)
- Manual DOM `classList` manipulation for search highlighting
- CSS `content-visibility` containment for large lists
- Strategic `untrack()` to break unnecessary effect dependencies

### Testing

Test files exist for: `NodePropertiesPanel`, `SearchPanel`, `TreeToolbar`, `ValidateModal`, `XmlSourceView`, `schema-helpers`, `search-helpers`, `modal`. Run with `npm run test` in `site/`.

---

## backend/ - Validation & MCP Server

### Tech Stack

| Layer       | Technology                           |
|-------------|--------------------------------------|
| Language    | Kotlin 2.3                           |
| Framework   | Ktor 3.4 (Netty engine)             |
| Build       | Gradle 9.3 (shadow JAR)             |
| JVM         | Java 25                             |
| MCP SDK     | io.modelcontextprotocol:kotlin-sdk 0.8.3 |
| Analytics   | PostHog 2.2                          |
| Serialization | kotlinx-serialization-json        |

### Key Commands

```bash
cd backend
./gradlew test                  # Run tests
./gradlew shadowJar             # Build fat JAR
./gradlew run                   # Run locally (port 8080)
```

### Environment Variables

| Variable         | Default                           | Purpose                    |
|------------------|-----------------------------------|----------------------------|
| `PORT`           | `8080`                            | Server port                |
| `SCHEMA_ROOT`    | `src/main/resources/schemas`      | Schema files root directory|
| `CONTENT_ROOT`   | `src/main/resources/content`      | Canonical content root (`examples/catalog.json` + XML files) |
| `POSTHOG_API_KEY`| (none)                            | Optional analytics key     |

### REST API Endpoints

| Method | Path          | Purpose                              |
|--------|---------------|--------------------------------------|
| GET    | `/`           | Redirects to ndc-clearance.netlify.app |
| GET    | `/schemas`    | List all indexed schemas (version -> messages) |
| POST   | `/validate`   | Validate XML against schema. Body: `{version, message, xml}` |
| GET    | `/api/diff`   | Compare schema versions. Query: `?from=V1&to=V2` |

No REST endpoints exist for examples/flows in this phase (MCP-only).

### MCP Tools (via SSE at `/mcp/sse`)

| Tool                | Description                                    |
|---------------------|------------------------------------------------|
| `validate_ndc_xml`  | Validate XML against a specific schema version |
| `list_versions`     | List all available NDC schema versions         |
| `list_schemas`      | List available messages (optionally by version)|
| `get_schema_files`  | Retrieve XSD file contents for a message       |
| `list_examples`     | List example metadata (optional message/version filters; no filters returns all) |
| `get_example_content` | Get XML content by `example_id` (optional metadata wrapper) |

### Source Structure (`src/main/kotlin/com/ndc/validator/`)

| File                   | Purpose                                          |
|------------------------|--------------------------------------------------|
| `Application.kt`      | Ktor bootstrap: plugins (CORS, SSE, JSON), service init |
| `Routes.kt`           | REST API endpoint definitions                    |
| `McpModules.kt`       | MCP server setup, tool registration, SSE transport |
| `ExampleService.kt`   | Loads canonical examples catalog and resolves XML content |
| `SchemaService.kt`    | Schema filesystem indexing and retrieval          |
| `ValidatorService.kt` | W3C XML Schema validation (javax.xml + Xerces)   |
| `SchemaDiffService.kt`| Schema comparison: message-level + element-level diffing |
| `PostHogService.kt`   | Anonymous analytics event tracking               |

### Schema Directory Layout

```
src/main/resources/schemas/{VERSION}/{MESSAGE_NAME}/
  ├── IATA_{MESSAGE_NAME}.xsd              # Main element definition
  └── IATA_{MESSAGE_NAME}_CommonTypes.xsd  # Shared type definitions

src/main/resources/content/examples/
  ├── catalog.json                          # Canonical example read model
  └── files/{iata|custom}/*.xml            # XML payloads
```

### Testing

- `ApiTest.kt` - Validates canonical IATA examples from `ndc_content/examples/catalog.json` against schemas
- `ExampleServiceTest.kt` - Unit tests for example catalog load/filter/content retrieval
- `SchemaDiffServiceTest.kt` - Unit tests for schema comparison

---

## tools/ - Kotlin CLI Tools

Independent Gradle project for schema processing and example management. Replaces the former `scripts/` Python tooling.

### Tech Stack

| Layer         | Technology                           |
|---------------|--------------------------------------|
| Language      | Kotlin 2.3                           |
| Build         | Gradle (application plugin)          |
| JVM           | Java 25                              |
| HTML parsing  | Jsoup 1.18                           |
| HTTP          | JDK `java.net.http.HttpClient`       |
| XML           | JDK `javax.xml` (validation, DOM, transform) |
| Serialization | kotlinx-serialization-json           |

### Key Commands

```bash
cd tools
./gradlew validate                              # Validate examples against flattened schemas
./gradlew validate --args='--schema-type=raw'   # Validate against raw schemas
./gradlew flatten                               # Batch flatten all versions
./gradlew download                              # Download IATA examples directly into ndc_content
./gradlew buildContentCatalog                   # Merge iata/custom + validate flows + emit catalog.json
./gradlew analyzeMissing                        # Analyze missing worked examples coverage
./gradlew test                                  # Run unit tests
```

### Source Structure (`src/main/kotlin/com/ndc/tools/`)

| File                         | Purpose                                                      |
|------------------------------|--------------------------------------------------------------|
| `ValidateWorkedExamples.kt`  | Validates XML examples against raw or flattened schemas (consolidates 3 former Python validators) |
| `FlattenNdcSchemas.kt`       | Flattens multi-file XSD into self-contained schemas with tree-shaking; supports single-version and batch mode |
| `DownloadWorkedExamples.kt`  | Scrapes IATA Confluence and writes canonical IATA files + source metadata |
| `BuildContentCatalog.kt`     | Builds canonical `catalog.json`, validates flow refs/message consistency, sets `flow_id` |
| `AnalyzeMissingExamples.kt`  | Gap analysis: message types defined vs covered by examples   |
| `common/NdcConstants.kt`     | Shared constants: version maps, project root resolution      |
| `common/ContentModels.kt`    | Canonical content data models + deterministic example ID builder |
| `common/XmlUtils.kt`         | Shared XML utilities: message info extraction from XML files |

### Testing

- `ValidateWorkedExamplesTest.kt` - Tests for schema extraction, XML validation, well-formedness checking, schema path resolution

### Typical Workflow

```bash
cd tools

# 1. Flatten all raw schemas
./gradlew flatten

# 2. Download IATA examples into canonical content
./gradlew download

# 3. Build canonical catalog used by site and backend
./gradlew buildContentCatalog

# 4. Validate examples
./gradlew validate
```

### Data Flow

```
raw_ndc_schemas/         →  ./gradlew flatten    →  ndc_schemas/
                                                      ├→ site/public/schemas/ (via copy-assets)
                                                      └→ backend/src/main/resources/schemas/ (via CI sync)

IATA Confluence wiki     →  ./gradlew download   →  ndc_content/examples/sources/iata.generated.json + files/iata/*.xml

custom examples/flows    →  edit ndc_content/examples/sources/custom.json + ndc_content/flows/flows.json

ndc_content/*            →  ./gradlew buildContentCatalog
                              └→ ndc_content/examples/catalog.json
                                  ├→ site/public/content/examples/ (via copy-assets)
                                  └→ backend/src/main/resources/content/ (via CI sync)
```

---

## .github/workflows/ - CI/CD

### deploy-backend.yml

**Triggers:** Push to `main` when `backend/**` or `ndc_content/**` changes
**Steps:** Checkout → Setup Java 25 → Sync schemas → Sync canonical content → Run tests → Build shadow JAR → Install KraftKit → Deploy to Unikraft Cloud
**Deploys to:** `mcp-ndc.sunrisehikers.io` (port 443→8080, 4Gi memory)
**Secrets:** `UKC_TOKEN`, `UKC_DEPLOYMENT_NAME`, `UKC_METRO`, `POSTHOG_API_KEY`

### deploy-site.yml

**Triggers:** Push to `main` when `site/**`, `ndc_schemas/**`, or `ndc_content/**` changes
**Steps:** Checkout → Setup Node 24 → npm ci → npm run build (with `PUBLIC_API_URL`) → Deploy to Netlify
**Deploys to:** Netlify (static hosting, production)
**Secrets:** `NETLIFY_AUTH_TOKEN`, `NETLIFY_SITE_ID`
**Build env:** `PUBLIC_API_URL=https://mcp-ndc.sunrisehikers.io`

---

## Development Guidelines

### Code Style

- **Site:** ESLint + Prettier enforced. 4-space indent, semicolons, trailing commas. No console.log (warn level). Unused vars prefixed with `_`.
- **Backend:** Kotlin conventions. Minimal codebase (~750 LOC total).
- **Tools:** Kotlin conventions. Independent Gradle project in `tools/`.

### Architecture Decisions

- **Astro SSG + Svelte 5 runes** for performance: static generation with islands of interactivity
- **Ktor over Spring** for backend: lightweight, coroutine-friendly, minimal overhead
- **Schema flattening** is a core value-add: tree-shaken self-contained XSDs that fit in LLM context windows
- **MCP integration** enables AI agents to validate NDC XML directly
- **DaisyUI** for consistent UI components without custom CSS overhead
- **Multi-file XSD support** in the viewer: schemas with CommonTypes are loaded as separate fetches and merged client-side

### Important Patterns

- XSD schemas live in `public/schemas/` for the site (copied at build time from `ndc_schemas/`)
- Canonical examples/flows live in `ndc_content/` and are shared by both site and backend
- Site consumes examples from `public/content/examples/catalog.json` (copied from `ndc_content/examples/catalog.json`)
- Backend consumes examples from `src/main/resources/content/examples/catalog.json` via `CONTENT_ROOT`
- `flow_id` is a permanent slug derived from the title (e.g., `shop-and-order-flight`) for SEO-friendly URLs
- Flows must have 100% step coverage (each step has an example) to be included in the catalog
- Version-to-message mapping is defined in `iata_ndc_messages.json` at the repo root
- Worked examples have a version mapping (e.g., schema ID "2134" → version "21.3.5") defined in `tools/src/main/kotlin/com/ndc/tools/common/NdcConstants.kt`
- CORS is open on the backend (any host allowed) - by design for broad access
